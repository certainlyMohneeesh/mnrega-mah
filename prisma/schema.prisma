generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// District master data for all Indian states
model District {
  id        String          @id @default(cuid())
  code      String          // District code (unique per state)
  name      String          // District name
  stateCode String          // "18" for Maharashtra, "01" for Andaman, etc.
  stateName String          // "Maharashtra", "Bihar", "West Bengal", etc.
  metrics   MonthlyMetric[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([stateCode, code]) // Composite unique: same district code can exist in different states
  @@index([stateCode])        // Fast state-wise filtering
  @@index([stateName])        // For UI dropdowns and searches
  @@map("districts")
}

// Monthly performance metrics for each district (from CSV data)
model MonthlyMetric {
  id         String   @id @default(cuid())
  districtId String
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  
  // Denormalized fields for fast queries (no joins needed)
  stateCode String // Denormalized from district for performance
  stateName String // Denormalized from district for UI
  
  // Time identifiers
  finYear String // e.g., "2024-2025"
  month   String // e.g., "Dec", "Nov", "July", "April"
  
  // Budget & Employment
  approvedLabourBudget                  Float?
  averageWageRatePerDay                 Float?
  averageDaysOfEmploymentPerHousehold   Float?
  differentlyAbledPersonsWorked         Int?
  
  // Expenditure (in Lakhs INR)
  materialAndSkilledWages        Float?
  totalExpenditure               Float?
  wages                          Float?
  totalAdministrativeExpenditure Float?
  
  // Works
  numberOfCompletedWorks Int?
  numberOfOngoingWorks   Int?
  numberOfWorksTakenUp   Int?
  numberOfGPsWithNilExp  Int?
  
  // Person Days
  personDaysOfCentralLiability Float?
  scPersonDays                 Float?
  stPersonDays                 Float?
  womenPersonDays              Float?
  
  // Households & Workers
  totalHouseholdsWorked            Int?
  totalIndividualsWorked           Int?
  totalNumberOfActiveJobCards      Int?
  totalNumberOfActiveWorkers       Int?
  totalNumberOfHHsCompleted100Days Int?
  totalNumberOfJobCardsIssued      Int?
  totalNumberOfWorkers             Int?
  scWorkersAgainstActiveWorkers    Float?
  stWorkersAgainstActiveWorkers    Float?
  
  // Percentages & Performance
  percentOfCategoryBWorks                  Float?
  percentOfExpenditureOnAgricultureAllied  Float?
  percentOfNRMExpenditure                  Float?
  percentagePaymentsGeneratedWithin15Days  Float?
  
  // Metadata
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([districtId, finYear, month])
  @@index([districtId])
  @@index([stateCode, finYear])  // Critical for state-wise queries
  @@index([stateName, finYear])  // For UI dropdowns
  @@index([finYear, month])      // Time-based queries
  @@index([finYear])
  @@index([month])
  @@map("monthly_metrics")
}

// Log of data fetch operations
model FetchLog {
  id            String   @id @default(cuid())
  source        String   // "data.gov.in"
  operation     String   // "fetch_monthly", "fetch_districts", etc.
  status        String   // "success", "error", "partial"
  recordsCount  Int      @default(0)
  errorMessage  String?  @db.Text
  requestParams Json?    // Store request parameters
  responseTime  Int?     // Response time in milliseconds
  startedAt     DateTime
  completedAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([source, status])
  @@index([startedAt])
  @@map("fetch_logs")
}

// Optional: User preferences and subscriptions
model User {
  id               String   @id @default(cuid())
  email            String?  @unique
  phone            String?  @unique
  preferredLocale  String   @default("mr") // "mr", "hi", "en"
  preferredDistrict String? // District code
  notificationsEnabled Boolean @default(false)
  emailNotifications   Boolean @default(false)
  smsNotifications     Boolean @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
  @@index([phone])
  @@map("users")
}
