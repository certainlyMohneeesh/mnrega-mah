// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// District master data for Maharashtra
model District {
  id        String   @id @default(cuid())
  code      String   @unique // District code from data.gov.in
  name      String   // District name in English
  nameHi    String?  // District name in Hindi
  nameMr    String?  // District name in Marathi
  stateCode String   @default("MH")
  stateName String   @default("Maharashtra")
  latitude  Float?
  longitude Float?
  population Int?
  area      Float?   // in sq km
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  metrics   MonthlyMetric[]

  @@index([code])
  @@index([stateCode])
  @@map("districts")
}

// Monthly performance metrics for each district
model MonthlyMetric {
  id                    String   @id @default(cuid())
  districtId            String
  year                  Int
  month                 Int      // 1-12
  
  // Work demand and provision
  householdsIssued      Int?     // Households issued job cards
  householdsEmployed    Int?     // Households provided employment
  personDaysGenerated   BigInt?  // Total person-days of employment
  womenPersonDays       BigInt?  // Person-days for women
  scPersonDays          BigInt?  // Person-days for SC
  stPersonDays          BigInt?  // Person-days for ST
  
  // Financial metrics (in INR)
  availableFunds        BigInt?  // Available funds
  totalExpenditure      BigInt?  // Total expenditure
  wageExpenditure       BigInt?  // Wages paid
  materialExpenditure   BigInt?  // Material expenditure
  
  // Works and completion
  worksCompleted        Int?     // Number of works completed
  worksOngoing          Int?     // Number of ongoing works
  
  // Average days and payments
  avgDaysPerHousehold   Float?   // Average days provided per household
  avgWageRate           Float?   // Average wage rate per day
  
  // Compliance metrics
  paymentWithin15Days   Int?     // Payments made within 15 days (%)
  demandRegistered      Int?     // Demand for work registered
  demandProvided        Int?     // Demand for work provided
  
  // Timestamps
  dataDate              DateTime // The month/year this data represents
  fetchedAt             DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  district              District @relation(fields: [districtId], references: [id], onDelete: Cascade)

  @@unique([districtId, year, month])
  @@index([districtId, year, month])
  @@index([dataDate])
  @@index([year, month])
  @@map("monthly_metrics")
}

// Log of data fetch operations
model FetchLog {
  id            String   @id @default(cuid())
  source        String   // "data.gov.in"
  operation     String   // "fetch_monthly", "fetch_districts", etc.
  status        String   // "success", "error", "partial"
  recordsCount  Int      @default(0)
  errorMessage  String?  @db.Text
  requestParams Json?    // Store request parameters
  responseTime  Int?     // Response time in milliseconds
  startedAt     DateTime
  completedAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([source, status])
  @@index([startedAt])
  @@map("fetch_logs")
}

// Optional: User preferences and subscriptions
model User {
  id               String   @id @default(cuid())
  email            String?  @unique
  phone            String?  @unique
  preferredLocale  String   @default("mr") // "mr", "hi", "en"
  preferredDistrict String? // District code
  notificationsEnabled Boolean @default(false)
  emailNotifications   Boolean @default(false)
  smsNotifications     Boolean @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
  @@index([phone])
  @@map("users")
}
